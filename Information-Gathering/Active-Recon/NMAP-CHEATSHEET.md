# NMAP Scanning for Network Scanning

---

### <a id="top-of-page"></a> LINKS

- [Command Flag Options](#flags)
- [Scanning Information & Examples](#scan-info)
  - Scan Network Range
  - Scan Multiple IPs
  - Host and Port Scanning
  - NMAP Scripting Engine
- [Firewall & IDS/IPS Evasion](#evasion)
  - Firewall Detection
  - IDS/IPS Detection
  - Decoys
  - DNS Proxying

</br>

## <a id="flags"></a>Command Flag Options

| **Nmap Option**              | **Description**                                                                   |
| ---------------------------- | --------------------------------------------------------------------------------- |
| `-sn`                        | Disables port scanning.                                                           |
| `-Pn`                        | Disables ICMP Echo Requests                                                       |
| `-n`                         | Disables DNS Resolution.                                                          |
| `-PE`                        | Performs the ping scan by using ICMP Echo Requests against the target.            |
| `--packet-trace`             | Shows all packets sent and received.                                              |
| `--reason`                   | Displays the reason for a specific result.                                        |
| `--disable-arp-ping`         | Disables ARP Ping Requests.                                                       |
| `--top-ports=<num>`          | Scans the specified top ports that have been defined as most frequent.            |
| `-p-`                        | Scan all ports.                                                                   |
| `-p22-110`                   | Scan all ports between 22 and 110.                                                |
| `-p22,25`                    | Scans only the specified ports 22 and 25.                                         |
| `-F`                         | Scans top 100 ports.                                                              |
| `-sS`                        | Performs an TCP SYN-Scan.                                                         |
| `-sA`                        | Performs an TCP ACK-Scan.                                                         |
| `-sU`                        | Performs an UDP Scan.                                                             |
| `-sV`                        | Scans the discovered services for their versions.                                 |
| `-sC`                        | Perform a Script Scan with scripts that are categorized as "default".             |
| `--script <script>`          | Performs a Script Scan by using the specified scripts.                            |
| `-O`                         | Performs an OS Detection Scan to determine the OS of the target.                  |
| `-A`                         | Performs OS Detection, Service Detection, and traceroute scans.                   |
| `-D RND:5`                   | Sets the number of random Decoys that will be used to scan the target.            |
| `-e`                         | Specifies the network interface that is used for the scan.                        |
| `-S 10.10.10.200`            | Specifies the source IP address for the scan.                                     |
| `-g`                         | Specifies the source port for the scan.                                           |
| `--dns-server <ns>`          | DNS resolution is performed by using a specified name server.                     |
| `-oA filename`               | Stores the results in all available formats starting with the name of "filename". |
| `-oN filename`               | Stores the results in normal format with the name "filename".                     |
| `-oG filename`               | Stores the results in "grepable" format with the name of "filename".              |
| `-oX filename`               | Stores the results in XML format with the name of "filename".                     |
| `--max-retries <num>`        | Sets the number of retries for scans of specific ports.                           |
| `--stats-every=5s`           | Displays scan's status every 5 seconds.                                           |
| `-v/-vv`                     | Displays verbose output during the scan.                                          |
| `--initial-rtt-timeout 50ms` | Sets the specified time value as initial RTT timeout.                             |
| `--max-rtt-timeout 100ms`    | Sets the specified time value as maximum RTT timeout.                             |
| `--min-rate 300`             | Sets the number of packets that will be sent simultaneously.                      |
| `-T <0-5>`                   | Specifies the specific timing template.                                           |

[Back to top](#top-of-page)

</br>

## <a id="scan-info"></a>Scanning Information & Examples

**Scan Network Range**

The most effective host discovery method is to use ICMP echo requests. The below network ping scan will disable port scanning. This scanning method works only if the firewalls of the hosts allow it. Otherwise, other scanning techniques can be used to find out if the hosts are active or not.

```
Anon4Now[/ATTACKER]$ sudo nmap 10.129.2.0/24 -sn -oA <OUTFILE> | grep for | cut -d" " -f5

10.129.2.4
10.129.2.10
10.129.2.11
10.129.2.18
10.129.2.19
10.129.2.20
10.129.2.28
```

**Scan Multiple IPs**

```
Anon4Now[/ATTACKER]$ sudo nmap -sn -oA <OUTFILE> 10.129.2.18 10.129.2.19 10.129.2.20| grep for | cut -d" " -f5

10.129.2.18
10.129.2.19
10.129.2.20
```

```
Anon4Now[/ATTACKER]$ sudo nmap -sn -oA <OUTFILE> 10.129.2.18-20| grep for | cut -d" " -f5

10.129.2.18
10.129.2.19
10.129.2.20
```

**Host and Port Scanning**

The 6 different states for a scanned port that can be obtained.

| **State**          | **Description**                                                                                                                                                                                       |
| ------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `open`             | This indicates that the connection to the scanned port has been established. These connections can be TCP connections, UDP datagrams as well as SCTP associations.                                    |
| `closed`           | When the port is shown as closed, the TCP protocol indicates that the packet we received back contains an RST flag. This scanning method can also be used to determine if our target is alive or not. |
| `filtered`         | Nmap cannot correctly identify whether the scanned port is open or closed because either no response is returned from the target for the port or we get an error code from the target.                |
| `unfiltered`       | This state of a port only occurs during the TCP-ACK scan and means that the port is accessible, but it cannot be determined whether it is open or closed.                                             |
| `open\|filtered`   | If we do not get a response for a specific port, Nmap will set it to that state. This indicates that a firewall or packet filter may protect the port.                                                |
| `closed\|filtered` | This state only occurs in the IP ID idle scans and indicates that it was impossible to determine if the scanned port is closed or filtered by a firewall.                                             |

By default, Nmap scans the top 1000 TCP ports with the SYN scan (-sS). This SYN scan is set only to default when NMAP is run as root because of the socket permissions required to create raw TCP packets. Otherwise, the TCP scan (-sT) is performed by default. Alternatively the option (--top-ports=n) can be used to scan either TCP or UDP ports that have been signed in the NMAP DB as the most frequently open.

**NMAP Scripting Engine**

There are a total of 14 categories into which these scripts can be divided.

| **Category** | **Description**                                                                                                                         |
| ------------ | --------------------------------------------------------------------------------------------------------------------------------------- |
| auth         | Determination of authentication credentials.                                                                                            |
| broadcast    | Scripts, which are used for host discovery by broadcasting and the discovered hosts, can be automatically added to the remaining scans. |
| brute        | Executes scripts that try to log in to the respective service by brute-forcing with credentials.                                        |
| default      | Default scripts executed by using the -sC option.                                                                                       |
| discovery    | Evaluation of accessible services.                                                                                                      |
| dos          | These scripts are used to check services for denial of service vulnerabilities and are used less as it harms the services.              |
| exploit      | This category of scripts tries to exploit known vulnerabilities for the scanned port.                                                   |
| external     | Scripts that use external services for further processing.                                                                              |
| fuzzer       | This uses scripts to identify vulnerabilities and unexpected packet handling by sending different fields, which can take much time.     |
| intrusive    | Intrusive scripts that could negatively affect the target system.                                                                       |
| malware      | Checks if some malware infects the target system.                                                                                       |
| safe         | Defensive scripts that do not perform intrusive and destructive access.                                                                 |
| version      | Extension for service detection.                                                                                                        |
| vuln         | Identification of specific vulnerabilities.                                                                                             |

```
Anon4Now[/ATTACKER]$ sudo nmap <target> -sC
```

```
Anon4Now[/ATTACKER]$ sudo nmap <target> --script <category>
```

```
Anon4Now[/ATTACKER]$ sudo nmap <target> --script <script-name>,<script-name>,...
```

[Back to top](#top-of-page)

</br>

## <a id="evasion"></a>Firewall & IDS/IPS Evasion

**Firewall Detection**

When a port is shown as filtered, it can happen for several reasons. In most cases, firewalls have certain rules set to handle specific connections, the packets can either be dropped, or rejected. The dropped packets are ignored, and no response is returned from the host.

This is different for rejected packets that are returned with an RST flag as these packets contain different types of ICMP error codes or contain nothing at all.

Such errors can be:

- Net Unreachable
- Net Prohibited
- Host Unreachable
- Host Prohibited
- Port Unreachable
- Proto Unreachable

Nmap's TCP ACK scan (-sA) method is much harder to filter for firewalls and IDS/IPS systems than regular SYN (-sS) or Connect scans (sT) because they only send a TCP packet with only the ACK flag. When a port is closed or open, the host must respond with an RST flag. Unlike outgoing connections, all connection attempts (with the SYN flag) from external networks are usually blocked by firewalls. However, the packets with the ACK flag are often passed by the firewall because the firewall cannot determine whether the connection was first established from the external network or the internal network. The goal is looking for 'unfiltered' ports with this type of scan.

**IDS/IPS Detection**

Unlike firewalls and their rules, the detection of IDS/IPS systems is much more difficult because these are passive traffic monitoring systems. Some possible steps that can be taken at a high-level are:

- IDS systems alone are usually there to help administrators detect potential attacks on their network. They can then decide how to handle such connections. The attacker can trigger certain security measures from an administrator, for example, by aggressively scanning a single port and its service. Based on whether specific security measures are taken, we can detect if the network has some monitoring applications or not.
- One method to determine whether such IPS system is present in the target network is to scan from a single host (VPS). If at any time this host is blocked and has no access to the target network, it can be determined that the administrator has taken some security measures. Accordingly, the attacker can continue attacks with another VPS.

**Decoys**

There are cases in which administrators block specific subnets from different regions in principle and this prevents any access to the target network. Another example is when IPS blocks traffic. For this reason, the Decoy scanning method (-D) is the right choice. With this method, Nmap generates various random IP addresses inserted into the IP header to disguise the origin of the packet sent. With this method, the attacker can generate random (RND) a specific number (for example: 5) of IP addresses separated by a colon (:). The real IP address is then randomly placed between the generated IP addresses.

The spoofed packets are often filtered out by ISPs and routers, even though they come from the same network range. Therefore, the attacker can also specify their VPS servers' IP addresses and use them in combination with "IP ID" manipulation in the IP headers to scan the target.

Another scenario would be that only individual subnets would not have access to the server's specific services. The attacker can also manually specify the source IP address (-S) to test for get better results. Decoys can be used for SYN, ACK, ICMP scans, and OS detection scans.

_--Scan by using Decoys--_

```
Anon4Now[/ATTACKER]$ sudo nmap 10.129.2.28 -p 80 -sS -Pn -n --disable-arp-ping --packet-trace -D RND:5
```

_--Scan by using different source IP--_

```
Anon4Now[/ATTACKER]$ sudo nmap 10.129.2.28 -n -Pn -p 445 -O -S 10.129.2.200 -e tun0
```

**DNS Proxying**

By default, Nmap performs a reverse DNS resolution unless otherwise specified to find more important information about the target. These DNS queries are also passed in most cases because the given web server is supposed to be found and visited. The DNS queries are made over the UDP port 53. The TCP port 53 was previously only used for the so-called "Zone transfers" between the DNS servers or data transfer larger than 512 bytes. More and more, this is changing due to IPv6 and DNSSEC expansions. These changes cause many DNS requests to be made via TCP port 53.

Nmap provides a way to specify DNS servers (--dns-server <ns>,<ns>), and this method could be fundamental if the attacker is in a demilitarized zone (DMZ). The company's DNS servers are usually more trusted than those from the Internet, so the attacker could use them to interact with the hosts of the internal network. Another example would be to use TCP port 53 as a source port (--source-port) for the scans. If the administrator uses the firewall to control this port and does not filter IDS/IPS properly, the TCP packets will be trusted and passed through. This can lead to using this DNS spoof attack technique with other tools like netcat.

_--SYN-Scan from DNS Port--_

```
Anon4Now[/ATTACKER]$ sudo nmap 10.129.2.28 -p50000 -sS -Pn -n --disable-arp-ping --packet-trace --source-port 53
```

_--Connect to filtered port using NC--_

```
Anon4Now[/ATTACKER]$ ncat -nv --source-port 53 10.129.2.28 50000
```

[Back to top](#top-of-page)

</br>
